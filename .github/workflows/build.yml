name: 构建 Windows EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    name: 构建 Windows 安装包
    runs-on: windows-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: 设置 Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装前端依赖
        run: npm ci
      
      - name: 安装后端依赖
        run: |
          cd backend
          uv sync
      
      - name: 构建前端
        run: npm run build
      
      - name: 打包 Windows 应用
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 列出构建文件
        run: |
          echo "构建完成的文件:"
          dir release
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: NovelMind-Windows-x64
          path: |
            release/*.exe
            release/*.zip
          retention-days: 90
          if-no-files-found: error
